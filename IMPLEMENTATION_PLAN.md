# Implementation Plan

_Generated by Ralph planning mode. This file is the single source of truth for what needs to be built._

## Status: Planned — Ready to Build

## Architecture

Three source files per `AGENTS.md`:
- `src/game.js` — All game logic (deck, dealing, actions, betting, state management). Pure functions, no I/O.
- `src/renderer.js` — All terminal rendering (ANSI colors, card art, screen layout). Reads game state, writes to `process.stdout`.
- `src/index.js` — Entry point. Wires game logic + renderer + user input via readline. Game loop + all timing/pauses live here.

Test files alongside source:
- `src/game.test.js` — Unit tests for game logic

---

## Resolved Ambiguities

These decisions resolve conflicts and gaps between specs. Builders must follow these.

1. **Split bet mechanics**: Standard blackjack rules apply. When splitting, the player puts up an **additional** bet equal to the original. A $100 bet becomes $100 per hand ($200 total at risk). The wording "original bet divided across hands" in `specs/split-hand-ui.md` is superseded — each hand carries the full original bet amount. Validate player has enough chips for the second bet before allowing split.

2. **State shape for split**: Use `splitHands` as the canonical array name. During split, state gains: `{ splitHands: [hand1, hand2], activeHandIndex: 0|1 }` where each hand is `{ cards: [], bet: N, status: 'playing'|'stand'|'bust'|'blackjack' }`. The `playerHand` field is unused during split. Renderer detects split mode by checking `state.splitHands !== undefined`.

3. **Dealer "showing" display**: The UI spec example "showing 14" is a typo. The correct behavior (per spec text and plan item) is to show only the face-up card's value. A visible 4 of clubs = "DEALER (showing 4)".

4. **21 after split is NOT blackjack**: Per standard casino rules, a natural 21 on a split hand pays 1:1, not 3:2. Only a 2-card 21 from the initial deal (before any split) counts as blackjack.

5. **Auto-stand at 21**: When a player's hand reaches exactly 21 after a hit, automatically stand. Hit is only available when total < 21 (per `specs/game-rules.md`).

6. **Pause/timing ownership**: All `setTimeout`/`async/await` pauses live in `src/index.js`. The `dealerPlay()` function in `game.js` is a step-at-a-time function (draws one card per call) so the game loop can insert pauses between draws. Alternatively, `dealerPlay()` returns the full sequence and the game loop animates it step by step.

7. **Play again resets chips but NOT stats**: When player chooses "play again" from Game Over, chips reset to $1,000 but session stats persist. A full app restart resets everything.

8. **Bets must be whole numbers**: Decimal bet amounts are invalid. Only integer bets $10-$500.

9. **`process.stdout.write()` for all rendering**: Per `specs/ui-design.md` technical notes. No `console.log` in the renderer.

10. **"P" key for split**: Show `[P]plit` in the action prompt bar ONLY when split is available (initial 2-card hand, matching ranks, sufficient chips). It appears alongside other actions.

---

## Implementation Items (Priority Order)

### Phase 1: Core Game Engine (`src/game.js`)

- [x] **1.1 — Deck creation**: Function `createDeck()` returns a standard 52-card array. Card objects: `{ suit, rank, value }`. Suits: ♠ ♥ ♦ ♣. Ranks: 2-10, J, Q, K, A. Values: 2-10 face, J/Q/K=10, A=11.
- [x] **1.2 — Fisher-Yates shuffle**: `shuffleDeck(deck)` using `Math.random()`. Returns new shuffled array (no mutation).
- [x] **1.3 — Game state initialization**: `createGameState()` returns initial state object:
  ```
  {
    deck: [],
    playerHand: [],
    dealerHand: [],
    chips: 1000,
    bet: 0,
    phase: 'welcome',    // 'welcome' | 'betting' | 'playing' | 'dealerTurn' | 'result' | 'gameOver'
    splitHands: undefined, // set to [hand1, hand2] when split is active
    activeHandIndex: 0,
    result: null,          // { outcome, message, chipChange } — set during settlement
    reshuffled: false,     // set to true when deck is reshuffled, renderer can display notification
    stats: {
      handsPlayed: 0,
      handsWon: 0,
      handsLost: 0,
      handsPushed: 0,
      blackjacks: 0,
      peakChips: 1000
    }
  }
  ```
- [x] **1.4 — Hand evaluation**: `calculateHandTotal(cards)` returns `{ total, soft }`. Handles ace optimization: count aces as 11, demote to 1 one-at-a-time if total > 21. `soft` is true when at least one ace is counted as 11.
- [x] **1.5 — Dealing logic**: `dealInitialCards(state)` — deal 2 cards each to player and dealer from deck. Auto-reshuffle if deck < 15 cards (set `state.reshuffled = true` when this happens). Returns new state with phase set to `'playing'`.
- [x] **1.6 — Blackjack detection**: `checkForBlackjack(state)` — check if player and/or dealer have natural 21 after initial deal. Mutual blackjack = push. Player blackjack = 3:2 payout. Dealer blackjack = player loses. Set phase to `'result'` and populate `state.result` if either has blackjack.
- [x] **1.7 — Player actions — Hit**: `playerHit(state)` — draw card, add to player hand, check bust (total > 21 → phase = `'result'`). Also auto-stand if total === 21 (set phase to `'dealerTurn'`). Return new state.
- [x] **1.8 — Player actions — Stand**: `playerStand(state)` — set phase to `'dealerTurn'`. Return new state.
- [x] **1.9 — Player actions — Double Down**: `playerDouble(state)` — only valid when: (a) initial 2-card hand, (b) player has enough chips to double the bet. Double bet (deduct additional amount from chips), draw exactly 1 card, then auto-stand. If bust, set phase to `'result'`. Return new state.
- [x] **1.10 — Dealer logic**: `dealerDrawOne(state)` draws one card for the dealer and returns updated state. `isDealerDone(state)` returns true when dealer total >= 17 (stands on soft 17). Game loop in `src/index.js` calls `dealerDrawOne` in a loop with pauses until `isDealerDone` returns true.
- [x] **1.11 — Hand comparison & bet settlement**: `settleRound(state)` — compare hands, calculate payout. Blackjack pays 3:2 (round to nearest dollar). Regular win 1:1. Push returns bet. Update chips, set `state.result = { outcome: 'win'|'lose'|'push'|'blackjack'|'bust', message, chipChange }`. Update stats. Return new state.
- [x] **1.12 — Session statistics tracking**: Called within `settleRound`. Update: `handsPlayed++`, `handsWon/Lost/Pushed++` based on outcome, `blackjacks++` if natural BJ, `peakChips = Math.max(peakChips, chips)`. Win rate formula: `(handsWon / handsPlayed * 100).toFixed(1)` with `"0.0"` guard when `handsPlayed === 0`. Export a `getWinRate(stats)` helper.
- [x] **1.13 — Bet validation**: `placeBet(state, amount)` — validate: (a) integer, (b) >= $10, (c) <= $500, (d) <= available chips. Return `{ valid: true, state: newState }` or `{ valid: false, error: "message" }`. On valid: deduct bet from chips, set `state.bet`, advance phase to `'playing'`.
- [x] **1.14 — Game over check**: After settlement, if chips < $10 minimum bet → set phase to `'gameOver'`. Called at end of `settleRound` or as a separate `checkGameOver(state)` function.
- [x] **1.15 — Action availability helpers**: `getAvailableActions(state)` returns an object `{ hit, stand, double, split, quit }` with boolean values. Logic:
  - `hit`: phase === 'playing' && total < 21 && not split-completed
  - `stand`: phase === 'playing'
  - `double`: phase === 'playing' && playerHand.length === 2 && !splitHands && chips >= bet
  - `split`: phase === 'playing' && playerHand.length === 2 && !splitHands && playerHand[0].rank === playerHand[1].rank && chips >= bet
  - `quit`: always true
  This function is used by both the renderer (to dim unavailable actions) and the game loop (to reject invalid inputs).
- [x] **1.16 — Split logic**: `playerSplit(state)` — only valid per `getAvailableActions`. Deduct additional bet from chips. Create `splitHands` array with two hands, each containing one of the original cards + one newly dealt card. Set `activeHandIndex = 0`. Each hand has `{ cards, bet: originalBet, status: 'playing' }`. Aces split: deal 1 card to each, auto-set status to `'stand'`. No re-splitting.
- [x] **1.17 — Split hand play-through**: `splitHit(state)` and `splitStand(state)` — act on the active hand. When active hand busts or stands: if `activeHandIndex === 0`, advance to hand 1. When all hands complete (both have status !== 'playing'), advance phase to `'dealerTurn'`. Auto-stand at 21 for split hands too. No double down allowed during split. Also added `splitHit`/`splitStand` booleans to `getAvailableActions()` return value for split-mode action availability.
- [x] **1.18 — Split settlement**: Extend `settleRound` to handle split hands. Compare each hand independently against dealer. Each hand wins/loses its own bet. Stats: count each split hand as a separate hand played. Return state with per-hand results in `splitHands[n].result`.

### Phase 2: Terminal Renderer (`src/renderer.js`)

All rendering uses `process.stdout.write()` — no `console.log`.

- [x] **2.1 — ANSI color utilities**: Helper functions: `red(s)`, `green(s)`, `yellow(s)`, `cyan(s)`, `bold(s)`, `dim(s)`, `reset`. Raw `\x1b[` codes, no dependencies. Also `magenta(s)` for blackjack emphasis.
- [x] **2.2 — Number formatting utility**: `formatChips(n)` returns string like `$1,000`. Use `toLocaleString('en-US')` or manual comma insertion. Used by all screens that display chip amounts. Implement early — needed by almost every renderer item.
- [x] **2.3 — Card ASCII art rendering**: `renderCard(card, faceDown?)` — returns array of 5 strings (the 5 lines of a card). Face-down: ░ pattern. Handle 10 (two-digit rank alignment). Color suits: red for ♥♦, white for ♠♣. Dim borders via `dim()`.
- [x] **2.4 — Hand rendering (side-by-side)**: `renderHand(cards, options?)` — take array of card objects, render side-by-side by interleaving card line arrays. 1 space between cards. `options.dimmed` for inactive split hand.
- [x] **2.5 — Screen frame**: Box-drawing character frame (╔═╗║╚═╝). Outer frame width = 44 characters total (1 + 42 inner + 1). `frameLine(content)` pads/truncates content to fit within `║...║`. Content centered within 80-column terminal.
- [x] **2.6 — Header bar**: Render `♠ BLACKJACK 21 ♠` title centered in frame header row.
- [x] **2.7 — Chip/bet status bar**: Render `Chips: $X,XXX` (yellow) and `Bet: $XXX` (white) in sub-header. Use `formatChips()`.
- [x] **2.8 — Dealer area**: Render dealer's cards with label. During player turn: `"DEALER (showing X)"` where X = face-up card value only. After dealer plays: `"DEALER (X)"` with actual total. If soft hand, show soft indicator.
- [x] **2.9 — Player area**: Render player's cards with label `"YOUR HAND (X)"`. Show `"Soft X"` when hand is soft (an ace counting as 11). Show `"BLACKJACK!"` in bold cyan/magenta when natural 21.
- [x] **2.10 — Action prompt bar**: Render available actions dynamically using `getAvailableActions(state)`. Show: `[H]it [S]tand [D]ouble [P]plit [Q]uit`. Dim unavailable actions. `[P]plit` only visible when split is available. `[D]ouble` dimmed after first hit or during split. During split, show `"Hand N: [H]it [S]tand"` per `specs/split-hand-ui.md`.
- [x] **2.11 — Full screen render function**: `renderGameScreen(state)` — clear screen (`\x1b[2J\x1b[H`), compose all sections, write to `process.stdout.write()`. Single full redraw. Show reshuffle notification if `state.reshuffled === true`.
- [x] **2.12 — Welcome screen**: Render per UI spec: `♠ ♥ BLACKJACK 21 ♣ ♦` centered, `"Press ENTER to play"` below, all within box frame.
- [x] **2.13 — Betting prompt screen**: Render the betting phase: chip count (yellow), input prompt `Place your bet ($10-$500):`. Show `[Q]uit` option. Accept 'Q' to quit from betting screen.
- [ ] **2.14 — Result display**: Large win/loss/push/blackjack message, color-coded: win = green, loss = red, push = yellow, blackjack = bold cyan. Show chip change: `+$150` in green or `-$50` in red. Use `formatChips()`.
- [ ] **2.15 — Game Over screen**: Render game over with: final chips (yellow, formatted), hands played, win rate (`getWinRate(stats)` with `%`), `"Press ENTER to play again"`, `"Press Q to quit"`. All within box frame.
- [ ] **2.16 — Split hand rendering**: Per `specs/split-hand-ui.md`. Side-by-side layout with labels: `"HAND 1 (X) *active*"`, `"HAND 2 (X) - Stand"`. Active hand in bold, inactive hand dimmed. Show per-hand bet amounts. Vertical stacking fallback if terminal width < threshold. Per-hand result display after settlement (win/loss/push per hand with chip change).

### Phase 3: Game Loop & I/O (`src/index.js`)

All timing/pauses live here. `game.js` is never imported with I/O side effects.

- [ ] **3.0 — CLI entry point setup**: Add shebang `#!/usr/bin/env node` as first line of `src/index.js`. Make file executable (`chmod +x`). Parse `process.argv` for `--help` (print usage and exit) and `--version` (read version from package.json and exit). All other args or no args launch the game. This enables `21black` command after `npm link`. See `specs/cli-interface.md`.
- [ ] **3.1 — Readline setup & signal handling**: Configure `readline.createInterface` with `process.stdin/stdout`. Handle raw mode for single-keypress input. Catch SIGINT (Ctrl+C) — restore terminal (disable raw mode, show cursor `\x1b[?25h`), exit cleanly. This must be set up first to prevent broken terminal during development.
- [ ] **3.2 — Welcome flow**: Show welcome screen, wait for ENTER, transition to betting phase.
- [ ] **3.3 — Betting input loop**: Show betting screen, read input (numeric or 'Q'). Validate via `placeBet()`. On invalid: show error message, re-prompt. On 'Q': clean exit. On valid: deal cards.
- [ ] **3.4 — Deal & blackjack check**: Call `dealInitialCards()`, render, check blackjack via `checkForBlackjack()`. If blackjack (player or dealer), show result with pause, then advance to next hand or game over.
- [ ] **3.5 — Player action loop**: Read single keypress (H/S/D/P/Q). Check `getAvailableActions()` — reject unavailable actions (beep or ignore). Dispatch to game functions. Re-render after each action. Loop until phase changes from `'playing'`.
- [ ] **3.6 — Dealer turn with dramatic pauses**: Reveal hole card first (re-render with both dealer cards visible — this is its own visual beat with a 300ms pause). Then loop: call `dealerDrawOne()`, re-render, pause 300-400ms, repeat until `isDealerDone()`. Each card draw is a separate render for dramatic effect.
- [ ] **3.7 — Result display & pause**: Show result via `settleRound()` + render. Pause 2-3 seconds. Then check game over. If not game over, prompt: `"Press ENTER for next hand or Q to quit"`.
- [ ] **3.8 — Game over flow**: Show game over screen with stats. Wait for ENTER (play again — reset chips to $1000, keep stats) or Q (quit). On play again, return to betting phase.
- [ ] **3.9 — Quit handling**: Clean exit on Q at any prompt point (betting, playing, result, game over). Restore terminal state: disable raw mode, show cursor, clear screen or leave final state visible.
- [ ] **3.10 — Split hand input routing**: During split play, show active hand indicator. Route H/S to `splitHit()`/`splitStand()` on active hand. Re-render between each action. When hand 1 completes, auto-advance to hand 2 (brief pause). When all hands done, proceed to dealer turn.

### Phase 4: Tests (`src/game.test.js`)

Use Node.js built-in test runner (`node --test`). Tests should be written alongside Phase 1 items — they don't need to wait until all game logic is done.

- [x] **4.1 — Deck tests**: Verify 52 cards, correct suits/ranks/values, no duplicates. Verify card object shape `{ suit, rank, value }`.
- [x] **4.2 — Shuffle tests**: Verify shuffle produces different order (statistical — run multiple times), maintains all 52 cards, does not mutate original.
- [x] **4.3 — Hand evaluation tests**: Test basic totals (e.g., 7+5=12), soft hands (A+6=soft 17), ace demotion (A+6+8=15 not 25), multiple aces (A+A=12 soft), blackjack detection (A+K=21 with 2 cards).
- [ ] **4.4 — Player action tests**: Hit draws card + busts correctly. Stand advances phase. Double: doubles bet, draws exactly 1 card, auto-stands. Double rejected when chips insufficient. Double rejected after first hit.
- [x] **4.5 — Dealer logic tests**: Dealer hits below 17, stands on 17, stands on soft 17 (A+6=17 stands, not hits). Also tests for dealerDrawOne: draws card, preserves state, multi-draw sequences, bust scenarios.
- [x] **4.6 — Bet settlement tests**: All outcomes — player win (1:1), dealer win, push (bet returned), blackjack (3:2 payout: $100 bet → $150 win → $250 total), bust scenarios. Mutual blackjack = push.
- [x] **4.7 — Bet validation tests**: Min $10, max $500, insufficient chips rejected, valid bet accepted. Non-integer rejected. Zero/negative rejected.
- [ ] **4.8 — Split tests**: Split creation (matching rank), aces-split auto-stand, independent hand play-through, settlement of both hands independently. 21 on split hand pays 1:1 not 3:2. Split rejected when chips insufficient. Split rejected when ranks don't match.
- [x] **4.9 — Stats tests**: Verify stats accumulate correctly across multiple rounds. Win rate calculation. Peak chips tracking. Blackjack count.
- [ ] **4.10 — Deck reshuffle tests**: Verify reshuffle triggers when deck drops below 15 cards. Verify `reshuffled` flag is set. Verify new deck has 52 cards.
- [x] **4.11 — Action availability tests**: Test `getAvailableActions()` in various states: initial deal (all available if ranks match), after first hit (no double/split), during split (no double/split), at 21 (no hit), when chips < bet (no double/split).
- [ ] **4.12 — Auto-stand at 21 test**: Verify player auto-stands when hitting to exactly 21.
- [x] **4.13 — Game over tests**: Verify game over triggers when chips < $10 after settlement.

### Phase 5: Polish & Edge Cases

- [ ] **5.1 — Terminal width handling**: Detect terminal width via `process.stdout.columns`. Center the 44-char frame within available width. If terminal < 44 columns, render without frame (graceful degradation). Log warning if < 80 columns but still render.
- [ ] **5.2 — Input edge cases**: Handle unexpected input gracefully — non-numeric bet input (show error, re-prompt), unknown keys during play (ignore), empty ENTER during betting (re-prompt), negative numbers/zero (show error). No crashes on any input.
- [ ] **5.3 — Re-shuffle notification**: When `state.reshuffled === true`, render a brief `"♻ Deck reshuffled"` message (dim) above the dealer area. Clear the flag after displaying: `state.reshuffled = false` in the game loop after render.
- [ ] **5.4 — Final integration test**: Run `node src/index.js` and verify full game loop works end-to-end. Syntax check all files via `node --check`. Run all tests, verify passing.

---

## Specs

| Spec File | Covers |
|---|---|
| `specs/game-rules.md` | Full blackjack rules, betting, game flow |
| `specs/ui-design.md` | Card art, colors, layout, screens, animations |
| `specs/session-stats.md` | Session statistics tracking |
| `specs/split-hand-ui.md` | Split hand rendering layout |
| `specs/cli-interface.md` | CLI command setup, --help, --version |

## Notes

- Zero external dependencies — pure Node.js with ES modules
- Node.js 18+ required (built-in test runner: `node --test`)
- Game logic in `src/game.js` must be fully pure/testable — no I/O side effects
- All rendering via `src/renderer.js` using `process.stdout.write()` — game logic never writes to stdout
- Card data as plain objects: `{ suit: '♠', rank: 'A', value: 11 }`
- State is a plain object, not class-based
- Split is lowest priority within game logic (Phase 1.16-1.18) since it's the most complex player action
- Tests should be written alongside Phase 1, not deferred — `game.js` is pure and testable from the start
- Ctrl+C handling is in Phase 3.1 (not deferred to Phase 5) to prevent broken terminal during development
- Number formatting is in Phase 2.2 (not deferred to Phase 5) since it's needed by nearly every renderer item

## Key Changes from Previous Plan

1. **Moved number formatting** from Phase 5 to Phase 2.2 — needed by all chip displays
2. **Moved Ctrl+C handling** from Phase 5 to Phase 3.1 — needed from first moment of development
3. **Merged soft hand display** (was duplicated in 2.8 and 5.5) — now only in 2.8/2.9
4. **Merged dealer "showing" logic** (was split between 2.7 and 5.6) — now fully in 2.8
5. **Added action availability helpers** (1.15) — central source of truth for what actions are valid
6. **Added `[P]plit` to action prompt** (2.10) — was missing from UI, players couldn't discover split
7. **Added split affordability validation** (1.15, 1.16) — prevents split/double when chips insufficient
8. **Added auto-stand at 21** (1.7) — per game-rules spec, hit unavailable at exactly 21
9. **Added mutual blackjack = push** (1.6) — edge case was implicit, now explicit
10. **Added `reshuffled` flag** to state (1.3, 1.5) — enables reshuffle notification in renderer
11. **Added per-hand split results** in renderer (2.16) — was missing from renderer plan
12. **Added dealer hole card reveal** as separate visual beat (3.6) — per UI spec animation requirement
13. **Added 4 new test items** (4.11-4.13) — action availability, auto-stand, game over
14. **Resolved 10 ambiguities** in dedicated section — split bets, state shape, showing total, etc.
15. **Split settlement** broken into its own item (1.18) — complex enough to warrant separate task
16. **Reduced Phase 5** from 8 items to 4 — many items were moved to their correct phases
